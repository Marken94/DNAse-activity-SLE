import pandas as pd
import statsmodels.api as sm
import numpy as np
import matplotlib.pyplot as plt
import seaborn as sns

# Create DataFrame with log-transformed data
data = {
    'DNAse_activity': [1.6308693697303134, 1.2663194407191671, 1.1090751215363703, 1.0694005571876124, 1.0582122412592614,
                    0.9933087893591191, 0.9591635502901927, 0.9497212128505284, 0.9443247181633744, 0.9247386713400422,
                    0.8503692765016349, 0.8352167101824017, 0.7761197990529878, 0.7007651369216418, 0.5884621942531092,
                    0.5531958612923807, 0.5216845322270618, 0.47693736446280555, 0.4538013004789964, 0.4263209108376016,
                    0.37573126719995065, 0.36279714882394265, 0.0517003529242151, 0.042504633577077434, -0.31845124626558863,
                    -0.44439776014866567, -0.44701560610861657, -0.4573114782648668, -0.45928271198927845, -0.5153016469759989,
                    -0.5669986590549622, -0.5937664886256769, -0.6003435814326439, -0.6100015773926668, -0.6489965014336563,
                    -0.799724200888149, -0.8230699155494945, -0.8515824533086234, -0.8700524427193329, -0.8858562503281202,
                    -0.8864577200460362, -0.9111200438919482, -0.9438577379409476, -0.9742027586897084, -1.045275209020937,
                    -1.0617805821872568, -1.1174185464455488, -1.1357263031956206, -1.1756788751492286, -1.1983219409641068,
                    -1.2254830342714504, -1.2335127937603059, -1.2714027566165684, -1.2999889376778877, -1.5416643740080525,
                    -1.9496202437385421],
    'Histon_H1': [-0.5101961513136918, -0.254761207298939, -1.087246696328677, -0.36594614657792934, -0.30501769892099606,
                 -1.1576404266693252, -0.6858377282900155, -0.6992306592294508, -0.4701848033553697, -0.42395826655800745,
                 -0.37286979159790506, -0.40087050393491097, -1.4983930775811707, None, -1.5394028111023985,
                 -1.3555614105321614, -1.349498205121633, -1.7752080435073185, -1.4538276316830574, -1.2037726859705613,
                 None, -1.643782865780265, -1.1970895105809602, -1.1809169242562974, -2.2254830342714502,
                 -1.5924391505136375, None, -1.3642147644663483, -1.9792245118064422, -1.384576047114056,
                 -1.3427528701162836, None, -1.497163361378997, -1.1596429407966438, -1.2850000325879576,
                 None, -1.5927791070726036, -1.4891869894875038, None, -1.6513058097344588,
                 None, None, -1.4712118082251038, -1.474436941729933,
                 -1.7680209731684957, -1.0154726866562074, -1.2219935385764917, -1.5380515047962382, -1.3412256791556432,
                 None, None, -1.2528213286398355,
                 None, -1.2955920726131591, -1.4316809149048881, -1.417709317281006],


    'Cat_activity': [0.6483600109809317, 0.40483371661993806, -0.4559319556497244, 0.6020599913279624, -0.18708664335714442,
            0.6374897295125107, 0.4578818967339923, 0.5932860670204573, -0.09691001300805639, 0.4653828514484183,
            0.7715874808812554, 0.08990511143939793, 0.8432327780980095, 0.2528530309798932, 0.004321373782642578,
            0.6263403673750424, 0.5797835966168101, -0.11350927482751812, -0.8860566476931632, 0.6693168805661122,
            0.48713837547718647, 0.6503075231319364, 0.5763413502057929, 0.4471580313422192, 0.359835482339888,
            0.06818586174616162, None, None, 0.367355921026019, -0.09151498112135022,
            0.42651126136457523, None, 0.4082399653118496, 0.029383777685209667, 0.7573960287930241,
            -0.494850021680094, 0.33845649360460484, 0.3222192947339193, None, 0.5158738437116791,
            0.7466341989375788, 0.1643528557844371, 0.004321373782642578, 0.3159703454569177,
            0.9556877503135057, 0.6618126855372612, 0.06818586174616162, 0.7267272090265723, 0.5211380837040362,
            0.42160392686983106, -0.26760624017703144, -0.721246399047171,
            -0.5686362358410126, 0.893206753059848, -0.8538719643217619, 0.21748394421390627],
    'Anti_dsDNA': [2.4000398279060158, None, 2.547100657042985, None, None, 1.4130181359393625, 2.146490179307547, None,
                  None, 1.8682882766989393, None, None, 1.4670731575273563, 1.888421406650906, 2.5421254624105116,
                  None, None, 1.8249852377165188, 1.7889008902115315, 2.0941369112696284,
                  2.277014958919201, 1.7239766769690543, 2.526282660311724, 1.5102709429080785, None,
                  None, None, 1.2759078979675553, None, None,
                  1.633836944524173, None, None, None, None,
                  None, None, None, 2.5667083909456454, 1.08495428914662,
                  None, 1.44941652903017, 2.5380120048549406, None,
                  None, 1.4703053595810252, 1.1887952234574688, None, None,
                  None, None, None,
                  None, 2.286623620741714, 1.1223951311477793, None],

    'SELENA_SLEDAI': [0.7781512503836436, 0.3010299956639812, 1.146128035678238, 0.9030899869919435, 1,
                      0.9030899869919435, 0.9030899869919435, 0.6020599913279624, 0.7781512503836436, 0.47712125471966244,
                      0.6020599913279624, 1.2304489213782739, 0.6020599913279624, 0.7781512503836436, 0.9542425094393249,
                      0.7781512503836436, 0.6020599913279624, 0.7781512503836436, 0.6989700043360189, 1,
                      0.6020599913279624, 0.3010299956639812, 0.9542425094393249, 0.6020599913279624, None,
                      0.3010299956639812, None, None, None, 0.3010299956639812,
                      1.1760912590556813, None, 1.146128035678238, 0.6020599913279624, 0.8450980400142568,
                      None, 0.9030899869919435, 0.7781512503836436, 1, 0.9030899869919435,
                      None, 0.3010299956639812, 0.6020599913279624, 1.146128035678238,
                      1.2041199826559248, 0.9030899869919435, 0.8450980400142568, 0.7781512503836436, 1,
                      None, None, None,
                      None, 1.0791812460476249, None, 1.255272505103306],
    'Age': [1.7481880270062005, 1.6334684555795864, 1.5563025007672873, 1.6989700043360187, 1.8325089127062364,
            1.3979400086720377, 1.6812412373755872, 1.3222192947339193, 1.6232492903979006, 1.6812412373755872,
            1.7558748556724915, 1.591064607026499, 1.6434526764861874, 1.5563025007672873, 1.7634279935629373,
            1.8325089127062364, 1.6434526764861874, 1.8129133566428555, 1.7708520116421442, 1.8512583487190752,
            1.5563025007672873, 1.6532125137753437, 1.7634279935629373, 1.7993405494535817, None,
            1.6812412373755872, None, None, None, 1.568201724066995,
            1.5440680443502757, None, 1.662757831681574, 1.8388490907372552, 1.7853298350107671,
            None, 1.3979400086720377, 1.7481880270062005, 1.724275869600789, 1.6989700043360187,
            None, 1.7634279935629373, 1.8195439355418688, 1.4913616938342726,
            1.7993405494535817, 1.8573324964312685, 1.7160033436347992, 1.591064607026499, 1.7708520116421442,
            None, None, 1.6901960800285136,
            None, 1.5797835966168101, None, 1.845098040014257],
    'Disease_duration': [1.0413926851582251, 1.1139433523068367, 1.2041199826559248, 0.7781512503836436, 1.255272505103306,
                        0.6989700043360189, 0.7781512503836436, 0.47712125471966244, 1.2304489213782739, 1.2304489213782739,
                        1.1760912590556813, -0.769551078621726, 0.47712125471966244, 0.8450980400142568, 0.3010299956639812,
                        1.146128035678238, 0.47712125471966244, 1.3979400086720377, -0.045757490560675115, 0,
                        0.6020599913279624, 0.7781512503836436, 0.47712125471966244, 0.6020599913279624, None,
                        1.3010299956639813, None, None, None, 1,
                        1.1760912590556813, None, 0.8450980400142568, 0.8450980400142568, 1.380211241711606,
                        -0.045757490560675115, 0.47712125471966244, 1.0413926851582251, 1.3617278360175928, 0.7781512503836436,
                        None, 1.3222192947339193, 1.380211241711606, 0.8450980400142568,
                        -0.2218487496163564, 1.3617278360175928, 1.3010299956639813, 1.0791812460476249, 1.255272505103306,
                        None, None, 0.8450980400142568,
                        None, 1.0791812460476249, None, 1.255272505103306]
}

df = pd.DataFrame(data)

# Remove rows with missing values in the target variable
df = df.dropna(subset=['SELENA_SLEDAI'])

# Fill missing values in predictors with medians
for column in df.columns:
    if column != 'SELENA_SLEDAI':
        df[column] = df[column].fillna(df[column].median())

# Define predictors and target variable
X = df.drop('SELENA_SLEDAI', axis=1)
y = df['SELENA_SLEDAI']

# Add constant for intercept
X = sm.add_constant(X)

# Build multiple regression model
model = sm.OLS(y, X).fit()

# Print regression results
print(model.summary())

# Additionally: transform back from log scale for interpretation
print("\nCoefficients in original scale (10^coef):")
coefs = pd.DataFrame({
    'Variable': model.params.index,
    'Coef': 10**model.params,
    'P-value': model.pvalues
})
print(coefs)

# ------------------------------------------------------------
# Plots
# ------------------------------------------------------------

plt.figure(figsize=(15, 10))

# 1. Predicted vs Actual values plot
plt.subplot(2, 2, 1)
predicted = model.predict(X)
plt.scatter(y, predicted, alpha=0.6)
plt.plot([y.min(), y.max()], [y.min(), y.max()], 'r--', lw=2)
plt.xlabel('Actual values (log10)')
plt.ylabel('Predicted values (log10)')
plt.title('Actual vs Predicted values')
plt.grid(True)

# 2. Residuals plot
plt.subplot(2, 2, 2)
residuals = y - predicted
plt.scatter(predicted, residuals, alpha=0.6)
plt.axhline(y=0, color='r', linestyle='--')
plt.xlabel('Predicted values (log10)')
plt.ylabel('Residuals')
plt.title('Residuals analysis')
plt.grid(True)

# 3. Variable importance (by absolute coefficient values)
plt.subplot(2, 2, 3)
coefs = model.params.drop('const')
coefs = coefs.reindex(coefs.abs().sort_values(ascending=False).index)
coefs.plot(kind='bar')
plt.title('Variable importance (standardized coefficients)')
plt.ylabel('Coefficient')
plt.xticks(rotation=45, ha='right')
plt.grid(True)

# 4. Correlation matrix
plt.subplot(2, 2, 4)
corr_matrix = df.corr()
sns.heatmap(corr_matrix, annot=True, cmap='coolwarm', center=0)
plt.title('Correlation matrix')
plt.tight_layout()

plt.show()

# Additional plot: target variable distribution
plt.figure(figsize=(8, 5))
plt.hist(y, bins=15, edgecolor='black', alpha=0.7)
plt.xlabel('SELENA-SLEDAI (log10)')
plt.ylabel('Frequency')
plt.title('Target variable distribution')
plt.grid(True)
plt.show()
